#!/bin/bash

# VALHALLA CONTROLLED LAUNCH SCRIPT - WITH OOM FIXES
# This script launches the Valhalla multi-agent system with memory optimizations 
# Based on OOM_FIXES.md recommendations

# Load and export environment variables from .env
set -a && [ -f ".env" ] && source .env && set +a

# Colors for prettier output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}┌─────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│      VALHALLA LAUNCH SCRIPT (OOM FIX)   │${NC}"
echo -e "${BLUE}└─────────────────────────────────────────┘${NC}"

# OOM FIX: Set environment variables to prevent memory issues
export DISABLE_POLLING=false
export FORCE_GC=true
export NODE_OPTIONS="--max-old-space-size=512 --expose-gc"

echo -e "${YELLOW}[ENV] Setting environment variables:${NC}"
echo -e "  ${GREEN}DISABLE_POLLING=${DISABLE_POLLING}${NC}"
echo -e "  ${GREEN}FORCE_GC=${FORCE_GC}${NC}"
echo -e "  ${GREEN}NODE_OPTIONS=${NODE_OPTIONS}${NC}"

# Configuration
RELAY_SERVER_URL="http://localhost:4000"
RELAY_AUTH_TOKEN="elizaos-secure-relay-key"
TELEGRAM_GROUP_IDS="-1002550618173"  # Update with your group ID
LOG_DIR="./logs"

# Create logs directory if it doesn't exist
mkdir -p $LOG_DIR

# Clean up existing processes
echo -e "\n${YELLOW}[1] Stopping existing processes...${NC}"
if [ -f "./stop_agents.sh" ]; then
    echo -e "   ${BLUE}Stopping all agent processes...${NC}"
    ./stop_agents.sh all
else
    echo -e "   ${RED}Warning: stop_agents.sh not found, manually killing processes...${NC}"
    pkill -f "node.*agent" || true
fi

# Kill any old relay server
echo -e "   ${BLUE}Stopping relay server...${NC}"
pkill -f "node.*server.js" || true

# Wait for processes to fully stop
echo -e "   ${BLUE}Waiting for processes to stop...${NC}"
sleep 3

# Clean ports
if [ -f "./cleanup_ports.sh" ]; then
    echo -e "\n${YELLOW}[2] Cleaning ports...${NC}"
    ./cleanup_ports.sh
fi

# Add database cleanup steps
echo -e "\n${YELLOW}[2.1] Cleaning up database files...${NC}"
echo -e "   ${BLUE}Removing old SQLite database files to prevent schema conflicts...${NC}"
rm -f ./packages/agent/data/*.db
rm -f ./packages/agent/data/*.sqlite
rm -f ./packages/**/test_memory.db
rm -f ./packages/**/test_memory.sqlite
echo -e "   ${GREEN}Database files removed. Fresh schema will be created on startup.${NC}"

# Initialize database schema
echo -e "\n${YELLOW}[2.2] Initializing database schema...${NC}"
echo -e "   ${BLUE}Creating database tables including 'memories' table...${NC}"
node init_database.js
if [ $? -eq 0 ]; then
  echo -e "   ${GREEN}Database schema successfully initialized!${NC}"
else
  echo -e "   ${RED}Database initialization failed! Check errors above.${NC}"
  echo -e "   ${YELLOW}Proceeding anyway, but agents may encounter database errors.${NC}"
fi

# Check if gc scripts are available for all agents
echo -e "   ${BLUE}Verifying garbage collection scripts...${NC}"
for agent in "${agents[@]}"; do
  if [ -f "gc_${agent}.js" ]; then
    echo -e "   ${GREEN}Found GC script for ${agent}${NC}"
  else
    echo -e "   ${RED}WARNING: Missing gc_${agent}.js script!${NC}"
    echo -e "   ${YELLOW}This agent may experience memory issues without garbage collection.${NC}"
  fi
done

# Set Telegram bot tokens for each agent from .env file
echo -e "\n${YELLOW}[3.1] Configuring Telegram Bot Tokens...${NC}"

# Use tokens from .env file if available, otherwise use placeholders
export ETH_MEMELORD_BOT_TOKEN="${TELEGRAM_BOT_TOKEN_ETHMemeLord9000:-YOUR_TOKEN_HERE}"
export BAG_FLIPPER_BOT_TOKEN="${TELEGRAM_BOT_TOKEN_BagFlipper9000:-YOUR_TOKEN_HERE}"
export LINDA_EVANGELISTA_BOT_TOKEN="${TELEGRAM_BOT_TOKEN_LindAEvangelista88:-YOUR_TOKEN_HERE}"
export VC_SHARK_BOT_TOKEN="${TELEGRAM_BOT_TOKEN_VCShark99:-YOUR_TOKEN_HERE}"
export CODE_SAMURAI_BOT_TOKEN="${TELEGRAM_BOT_TOKEN_CodeSamurai77:-YOUR_TOKEN_HERE}"
export BITCOIN_MAXI_BOT_TOKEN="${TELEGRAM_BOT_TOKEN_BitcoinMaxi420:-YOUR_TOKEN_HERE}"

# Show masked versions of tokens for verification
mask_token() {
    local token="$1"
    local token_length=${#token}
    
    if [ "$token_length" -le 10 ] || [ "$token" == "YOUR_TOKEN_HERE" ]; then
        echo "$token" # Return full placeholder token
    else
        local first_six=${token:0:6}
        local last_two=${token: -2}
        echo "${first_six}...${last_two}"
    fi
}

echo -e "   ETH_MEMELORD_BOT_TOKEN: $(mask_token "$ETH_MEMELORD_BOT_TOKEN")"
echo -e "   BAG_FLIPPER_BOT_TOKEN: $(mask_token "$BAG_FLIPPER_BOT_TOKEN")"
echo -e "   LINDA_EVANGELISTA_BOT_TOKEN: $(mask_token "$LINDA_EVANGELISTA_BOT_TOKEN")"
echo -e "   VC_SHARK_BOT_TOKEN: $(mask_token "$VC_SHARK_BOT_TOKEN")"
echo -e "   CODE_SAMURAI_BOT_TOKEN: $(mask_token "$CODE_SAMURAI_BOT_TOKEN")"
echo -e "   BITCOIN_MAXI_BOT_TOKEN: $(mask_token "$BITCOIN_MAXI_BOT_TOKEN")"

echo -e "   ${GREEN}Telegram bot tokens configured${NC}"

# Start relay server
echo -e "\n${YELLOW}[4] Starting relay server...${NC}"
cd relay-server
export NODE_OPTIONS="--max-old-space-size=512" # Less memory for relay
PORT=4000 nohup node server.js > ../logs/relay-server.log 2>&1 &
RELAY_PID=$!
cd ..
echo -e "   ${GREEN}Relay server started with PID: ${RELAY_PID}${NC}"

# Wait for relay to start
echo -e "   ${BLUE}Waiting for relay server to initialize...${NC}"
sleep 5

# Check if relay server is running
echo -e "\n${YELLOW}[5] Verifying relay server...${NC}"
for i in {1..10}; do
    if curl -s http://localhost:4000/health | grep -q "status.*ok"; then
        echo -e "   ${GREEN}Relay server is up and running!${NC}"
        break
    elif [ $i -eq 10 ]; then
        echo -e "   ${RED}Failed to verify relay server is running. Check logs.${NC}"
        echo -e "   ${BLUE}Tail of relay log:${NC}"
        tail -n 10 $LOG_DIR/relay-server.log
        exit 1
    else
        echo -e "   ${BLUE}Waiting... ($i/10)${NC}"
        sleep 1
    fi
done

# Set environment variables for relay
export RELAY_SERVER_URL="http://localhost:4000"
export RELAY_AUTH_TOKEN=$RELAY_AUTH_TOKEN
export TELEGRAM_GROUP_IDS=$TELEGRAM_GROUP_IDS

# Define agents to launch
agents=("eth_memelord_9000" "bag_flipper_9000" "linda_evangelista_88" "vc_shark_99" "bitcoin_maxi_420" "code_samurai_77")
PORT=3000

# Launch GC helper scripts
echo -e "\n${YELLOW}[6] Starting Garbage Collection helper scripts...${NC}"
for agent in "${agents[@]}"; do
    node gc_${agent}.js > $LOG_DIR/gc_${agent}.log 2>&1 &
    GC_PID=$!
    echo -e "   ${GREEN}Started GC helper for ${agent} with PID: ${GC_PID}${NC}"
    echo $GC_PID > $LOG_DIR/gc_${agent}.pid
done

# Start each agent with staggered launch
echo -e "\n${YELLOW}[7] Starting agents with memory optimization...${NC}"
echo -e "   ${BLUE}Agents will be started with a 10 second delay between each${NC}"

for agent in "${agents[@]}"; do
    echo -e "   ${BLUE}Starting ${agent} on port ${PORT}...${NC}"
    
    # Create port file if needed
    mkdir -p ports
    echo $PORT > ports/${agent}.port
    
    # Set the correct bot token for each agent
    BOT_TOKEN=""
    case "${agent}" in
        eth_memelord_9000)
            BOT_TOKEN=$ETH_MEMELORD_BOT_TOKEN
            ;;
        bag_flipper_9000)
            BOT_TOKEN=$BAG_FLIPPER_BOT_TOKEN
            ;;
        linda_evangelista_88)
            BOT_TOKEN=$LINDA_EVANGELISTA_BOT_TOKEN
            ;;
        vc_shark_99)
            BOT_TOKEN=$VC_SHARK_BOT_TOKEN
            ;;
        code_samurai_77)
            BOT_TOKEN=$CODE_SAMURAI_BOT_TOKEN
            ;;
        bitcoin_maxi_420)
            BOT_TOKEN=$BITCOIN_MAXI_BOT_TOKEN
            ;;
    esac
    
    # Start the agent with the appropriate bot token
    NODE_OPTIONS="--max-old-space-size=512 --expose-gc" \
    DISABLE_POLLING=false \
    FORCE_GC=true \
    AGENT_ID="${agent}" \
    TELEGRAM_BOT_TOKEN="${BOT_TOKEN}" \
    cd /root/eliza && pnpm --filter @elizaos/agent start --isRoot \
      --character="characters/${agent}.json" \
      --clients=@elizaos/client-telegram \
      --plugins=@elizaos/telegram-multiagent \
      --log-level=debug \
      --port=$PORT > $LOG_DIR/${agent}.log 2>&1 &
    
    # Save PID
    AGENT_PID=$!
    echo $AGENT_PID > $LOG_DIR/${agent}.pid
    echo -e "   ${GREEN}Started ${agent} with PID: ${AGENT_PID}${NC}"
    
    # Increment port for next agent
    PORT=$((PORT + 1))
    
    # Wait between agent launches
    echo -e "   ${BLUE}Waiting 10 seconds before next agent launch...${NC}"
    sleep 10
done

# Wait for agents to initialize and register
echo -e "\n${YELLOW}[8] Waiting for agents to initialize and register...${NC}"
sleep 20

# Check agent registrations
echo -e "\n${YELLOW}[9] Verifying agent registration with relay...${NC}"
RELAY_HEALTH=$(curl -s http://localhost:4000/health)
AGENTS_COUNT=$(echo $RELAY_HEALTH | grep -o '"agents":[0-9]*' | cut -d':' -f2)
AGENTS_LIST=$(echo $RELAY_HEALTH | grep -o '"agents_list":"[^"]*"' | cut -d'"' -f4)

echo -e "   ${BLUE}Agents registered: ${AGENTS_COUNT}${NC}"
echo -e "   ${BLUE}Agents list: ${AGENTS_LIST}${NC}"

if [ "$AGENTS_COUNT" -lt "${#agents[@]}" ]; then
    echo -e "   ${YELLOW}Warning: Not all agents are registered with the relay server.${NC}"
    echo -e "   ${YELLOW}Expected ${#agents[@]} agents, but only ${AGENTS_COUNT} are registered.${NC}"
    echo -e "   ${YELLOW}Check agent logs for connection issues.${NC}"
else
    echo -e "   ${GREEN}All agents successfully registered with relay!${NC}"
fi

# Monitor instructions
echo -e "\n${GREEN}✅ Valhalla system launched with OOM fixes!${NC}"
echo -e "${BLUE}Available commands:${NC}"
echo -e "   - ${YELLOW}tail -f logs/*.log${NC}              - View all logs"
echo -e "   - ${YELLOW}tail -f logs/relay-server.log${NC}   - View relay logs"
echo -e "   - ${YELLOW}tail -f logs/eth_memelord_9000.log${NC} - View specific agent logs"
echo -e "   - ${YELLOW}ps aux --sort -rss | grep node${NC}  - Check memory usage"

echo
echo -e "${BLUE}┌─────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│    VALHALLA IS OPERATIONAL ⚔️  🛡️         │${NC}"
echo -e "${BLUE}└─────────────────────────────────────────┘${NC}" 